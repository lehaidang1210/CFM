@using Microsoft.AspNetCore.Http
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CFM - @ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="~/css/site.css" />
    <link rel="stylesheet" href="~/css/app.css" />
    <link rel="stylesheet" href="~/css/sidebar.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.css" />
    <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">


    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="shortcut icon" href="~/img/favicon.jpg" type="image/x-icon">
</head>

<body class="bg-light">
    <div id="app">
        <div class="container-fluid bg-light">
            <!-- sidebar -->
            <div id="sidebar" class="active">
                <div class="sidebar-wrapper active">
                    <div class="sidebar-header">
                        <div class="d-flex justify-content-between">
                            <div class="d-flex justify-content-center logo w-100">
                                <a asp-controller="Home" asp-action="Index">
                                    <img src="~/img/logo.jpg" alt="logo" srcset="" class="img-logo">
                                </a>
                            </div>
                            <div class="toggler">
                                <a class="cursor-pointer sidebar-hide d-xl-none d-block">
                                    <i class="bi bi-x bi-middle"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="sidebar-menu">
                        <ul class="menu">
                            <li class="sidebar-item main active">
                                <a asp-controller="Main" asp-action="Index" class='sidebar-link'>
                                    <i class="bi bi-pin-angle-fill"></i>
                                    <span>Đặt món</span>
                                </a>
                            </li>
                            <hr>
                            <li class="sidebar-item @(ViewBag.IsActive == "dashboard" ? "active" : "")">
                                <a asp-controller="Home" asp-action="Index" class='sidebar-link'>
                                    <i class="bi bi-bar-chart-line"></i>
                                    <span>Bảng tin</span>
                                </a>
                            </li>
                            <li class="sidebar-item @(ViewBag.IsActive == "table" ? "active" : "")">
                                <a asp-controller="Table" asp-action="Index" class='sidebar-link'>
                                    <i class="bi bi-x-diamond-fill"></i>
                                    <span>Quản lý bàn</span>
                                </a>
                            </li>
                            <li class="sidebar-item @(ViewBag.IsActive == "order" ? "active" : "")">
                                <a asp-controller="Order" asp-action="Index" class='sidebar-link'>
                                    <i class="icon-mid d-flex algin-items-center bi bi-receipt"></i>
                                    <span>Quản lý đơn hàng</span>
                                </a>
                            </li>
                            <li class="sidebar-item @(ViewBag.IsActive == "product" ? "active" : "")">
                                <a asp-controller="Product" asp-action="Index" class='sidebar-link'>
                                    <i class="icon-mid d-flex algin-items-center bi bi-cup-hot-fill"></i>
                                    <span>Quản lý sản phẩm</span>
                                </a>
                            </li>
                            <li class="sidebar-item has-sub setting">
                                <a class='sidebar-link cursor-pointer'>
                                    <i class="bi bi-gear-fill"></i>
                                    <span>Cài đặt</span>
                                </a>
                                <ul class="submenu">
                                    <li class="submenu-item @(ViewBag.IsActive == "user" ? "active" : "")">
                                        <a class="text-decoration-none" asp-controller="User" asp-action="Index">Tài
                                            khoản</a>
                                    </li>
                                    <li class="submenu-item @(ViewBag.IsActive == "setting" ? "active" : "")">
                                        <a class="text-decoration-none" asp-controller="Setting"
                                            asp-action="Index">Thiết lập hệ thống</a>
                                    </li>
                                    <li class="submenu-item @(ViewBag.IsActive == "log" ? "active" : "")">
                                        <a class="text-decoration-none" asp-controller="Log" asp-action="Index">Nhật ký
                                            hệ thống</a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <button class="sidebar-toggler btn"><i data-feather="x"></i></button>
                </div>
            </div>
            <!-- end sidebar -->

            <div id="main" class='layout-navbar'>
                <!-- header -->
                <header class="mb-3">
                    <nav class="navbar navbar-expand navbar-light px-1">
                        <div class="d-flex w-100">
                            <a href="#" class="burger-btn d-block">
                                <i class="bi bi-justify fs-3"></i>
                            </a>
                            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                                aria-expanded="false" aria-label="Toggle navigation">
                                <span class="navbar-toggler-icon"></span>
                            </button>
                            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                                <ul class="navbar-nav d-flex justify-content-start mb-2 mb-lg-0">
                                </ul>
                                <div class="dropdown ms-auto">
                                    <div data-bs-toggle="dropdown" aria-expanded="false" class="cursor-pointer">
                                        <div class="user-menu d-flex">
                                            <div class="user-name text-end me-3">
                                                <h6 class="mb-0 text-primary text-decoration-none auth-name">
                                                </h6>
                                                <p class="mb-0 text-sm text-gray-600 text-decoration-none auth-role">
                                                </p>
                                            </div>
                                            <div class="user-img d-flex align-items-center">
                                                <div class="avatar avatar-md">
                                                    <img src="~/img/avatar_admin.png" alt="Ảnh nè">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                                        <li>
                                            <h6 class="dropdown-header hello-auth">
                                            </h6>
                                        </li>
                                        <li>
                                            <a class="dropdown-item cursor-pointer btn-profile" asp-controller="Profile"
                                                asp-action="ProfileUser">
                                                <i class="icon-mid bi bi-person me-2"></i>Thông tin tài khoản</a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item cursor-pointer btn-profile-password"
                                                asp-controller="Profile" asp-action="ChangePassword" asp-route-id="2">
                                                <i class="icon-mid bi bi-key me-2"></i>Đổi mật khẩu</a>
                                        </li>
                                        <hr class="dropdown-divider">
                                        <li>
                                            <a class="dropdown-item" asp-controller="Login" asp-action="Logout">
                                                <i class="icon-mid bi bi-box-arrow-left me-2"></i>Đăng xuất</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </nav>
                </header>
                <!-- end header -->

                <main role="main" class="pb-3">
                    @RenderBody()
                </main>
            </div>
        </div>
    </div>
    <div class="modal" id="setting-example">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">QR chuyển khoản</h4>
                </div>
                <div class="modal-body">
                    <img class="img-fluid" alt="Example Image">
                </div>
            </div>
        </div>
    </div>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/apexcharts.js"></script>
    <script src="~/js/dashboard.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/moment.min.js"></script>
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/daterangepicker@3.1.0/daterangepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js">
    </script>
    <script type="text/javascript" charset="utf8"
        src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js">
        </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
<script>
    function visibilityFunction() {
        var inputPass = document.querySelector('.visibility');
        if (inputPass) {
            if (inputPass.getAttribute("type") === "password") {
                document.querySelector('.bi-eye-fill').classList.add('bi-eye-slash-fill');
                document.querySelector('.bi-eye-fill').classList.remove('bi-eye-fill');
                inputPass.setAttribute("type", "text");
            } else {
                document.querySelector('.bi-eye-slash-fill').classList.add('bi-eye-fill');
                document.querySelector('.bi-eye-slash-fill').classList.remove('bi-eye-slash-fill');
                inputPass.setAttribute("type", "password");
            }
        }
    }

    function calcBill() {
        let total = 0;
        $('.order-detail').each(function () {
            let sum = $(this).find('.order-product').find(':selected').attr('data-price') * $(this).find('.order-quantity').val();
            $(this).find('.display-price').text(number_format(sum));
            $(this).find('.order-price').val(sum);
            total += sum;
        })
        $('.bill-total').val(total)
        $('span.order-summary').text(number_format(total))
    }

    function number_format(nStr) {
        nStr += "";
        x = nStr.split(".");
        x1 = x[0];
        x2 = x.length > 1 ? "." + x[1] : "";
        var rgx = /(\d+)(\d{3})/;
        while (rgx.test(x1)) {
            x1 = x1.replace(rgx, "$1" + "," + "$2");
        }
        return x1 + x2;
    }


    ///Hình ảnh product
    function selectFile(obj) {
        obj.querySelector('input[type="file"]').click()
    }

    var inputFile = $('input[name="imageFile"]');
    var imgPreview = $('.img-preview');
    inputFile.on('change', function () {
        if (this.files && this.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                imgPreview.attr('src', e.target.result);
            }
            reader.readAsDataURL(this.files[0]);
        } else {
            imgPreview.attr('src', '');
        }
    });

    $(document).ready(function () {
        $(".submenu-item.active").parents(".submenu").addClass("d-block active").parents(".has-sub").addClass("active");

        $.get('/User/GetUserInfo', function (data) {
            $('.auth-name').text(data.name)
            switch (data.role) {
                case 1:
                    $('.auth-role').text('Admin');
                    break;
                case 2:
                    $('.auth-role').text('Chủ quán');
                    break;
                default:
                    $('.auth-role').text('Nhân viên');
                    $('.setting').empty();
                    break;
            }
            $('.hello-auth').text('Chào bạn, ' + data.name)
        })

        $(document).on('click', '.btn-add-product', function () {
            $(this).parents('#order-form').find('.btn-pay').addClass('d-none');
            const index = $('.order-product').length;
            $.get('/Product/Load', function (data) {
                var str = `<div class="row order-detail mb-2" data-index="${index}">
                            <div class="col-12 col-lg-4">
                                <select name="details[${index}].ProductId" id="order-products-${index + 1}" class="form-control form-select rounded-2 order-product mb-1 mb-lg-0">
                                    <option value="" selected hidden disabled>Chọn món</option>`;
                $.each(data.products, function (key, product) {
                    str += `<option value="${product.id}" data-price="${product.price}">${product.name}</option>`
                });
                str += ` </select>
                            </div>
                                <div class="col-4 col-lg-2">
                                    <input type="hidden" name="details[${index}].OrderId" value="1" class="detail-order-id">
                                    <span type="text" id="order-prices-${index + 1}" class="form-control border border-0 text-end order-price px-0" autocomplete="off"><span>
                                </div>
                                <div class="col-2 col-lg-2">
                                    <input type="number" name="details[${index}].Quantity" id="order-quantities-${index + 1}" value="0" class="form-control border border-0 text-end order-quantity ps-0" inputmode="numeric" autocomplete="off" placeholder="Số lượng" disabled>
                                </div>
                                <div class="col-3 col-lg-2 d-flex align-items-center justify-content-end">
                                    <div class="display-price"></div>
                                    <input type="hidden" name="details[${index}].Price" id="order-price-${index + 1}" value="0" class="form-control border border-0 text-end order-price ps-0" autocomplete="off" readonly>
                                </div>
                                <div class="col-3 col-lg-2 d-flex">
                                    <button type="button" class="btn btn-outline-secondary border border-0 btn-cancel rounded-2">&times;</button>
                                </div>
                            </div>
                            <div class="d-flex align-items-center mb-5">
                                <input type="text" name="details[${index}].Note" class="form-control small order-note w-100" placeholder="Ghi chú">
                            </div>`
                $('#order-details').append(str)
            })
        })

        $(document).on('click', '.btn-remove', function (e) {
            e.preventDefault();
            let form = $(this).parent(), status = $(this).parents('tr').find('.status').text();
            if ($('.auth-role').text() == 'Nhân viên') {
                Swal.fire({
                    title: "Lưu ý!",
                    text: "Bạn không có quyền hạn thực hiện thao tác này!",
                    icon: "warning",
                    showConfirmButton: true,
                    confirmButtonText: "OK, Đã hiểu!",
                })
            } else if (status == "Chưa thanh toán") {
                Swal.fire({
                    title: "Lưu ý!",
                    text: "Đơn hàng chưa thanh toán không thể xóa!",
                    icon: "warning",
                    showConfirmButton: true,
                    confirmButtonText: "OK, Đã hiểu!",
                });
            } else if (status == "Có khách") {
                Swal.fire({
                    title: "Lưu ý!",
                    text: "Hiện tại bàn đang có khách, không thể xóa!",
                    icon: "warning",
                    showConfirmButton: true,
                    confirmButtonText: "OK, Đã hiểu!",
                });
            } else {
                Swal.fire({
                    title: "Lưu ý!",
                    text: "Bạn có chắc chắn xóa?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonText: "Vâng, xóa đi!",
                    cancelButtonText: "Không, hủy bỏ!",
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            data: form.serializeArray(),
                            url: form.attr("action"),
                            method: form.attr("method"),
                            success: function (response) {
                                Toastify({
                                    text: response.title,
                                    duration: 1000,
                                    close: true,
                                    gravity: "top",
                                    position: "center",
                                    backgroundColor: "var(--bs-" + response.status + ")",
                                }).showToast();
                                window.location.href = "\\" + response.controller + "\\Index";
                            },
                            error: function (response) {
                                Toastify({
                                    text: response.title,
                                    duration: 1000,
                                    close: true,
                                    gravity: "top",
                                    position: "center",
                                    backgroundColor: "var(--bs-" + response.status + ")",
                                }).showToast();
                            }
                        });
                    }
                });
            }
        })
    })
</script>

</html>
